<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="../build/formulizer.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
        <script src="capitals.geojson" type="text/javascript"></script>
        <script src="countries.geojson" type="text/javascript"></script>
</head>

<body>
    <div class="row">
        <div class="col-md-6">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" onclick="setPanel('form')">Formulaire</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="setPanel('fzform')">Form</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="setPanel('data')">Data</a>
                </li>
            </ul>
            <div id=formPanel>
                <fz-form style="width: 100%;" id="fzform"></fz-form>
            </div>
            <div id=fzformPanel>
                <textarea id="fzform" style="width:100%;height:600px;"></textarea>
            </div>
            <div id=dataPanel>
                <pre id=data style="width: 100%;height: 600px;font-size: 1em;background-color: lightgray;"></pre>
            </div>
        </div>
        <div class="col-md-6">
            <div style="width: 500px;height: 400px;" id="map"></iframe>
            </div>
        </div>

</body>

<script>
    const panels = {
        form: document.getElementById('formPanel'),
        fzform: document.getElementById('fzformPanel'),
        data: document.getElementById('dataPanel')
    }

    const fzform = document.getElementById('fzform')
    const fzform = document.getElementById('fzform')
    const data = document.getElementById('data')
    const timer = null
    let property = ""
    let dataset = ""
    let selectcb = () => null
    let selected = null
    const style = {
      stroke: true,
      color: "#9933ff",
      weight: 2,
      opacity: 0.7,
      fill: true,
      fillColor: "#7300e6",
      fillOpacity: 0.15,
      smoothFactor: 0.5,
      interactive: false,
    }

    function setPanel(panel) {
        Object.keys(panels).forEach(id => panels[id].style.display = "none");
        panels[panel].style.display = "block"
    }
    const goto = async () => {
        const tutodata = await fetch(`./tutos/accroche.json`).then(r => r.json())
        fzform.options = {
            asset: {
                select: async (fieldasset, value, cb) =>  {
                    // start selection process (in SAMI $map.selectionDisplay()
                    property =fieldasset.id
                    dataset = fieldasset.class
                    selectcb = cb
                },
                done: async () => {
                    // terminate selection process (in SAMI $map.selectionTerminate())
                    selected = null
                    selectcb = () => null
                    return
                }
            }
        }
        fzform.schema = tutodata.form
        fzform.value = JSON.stringify(tutodata.form, null, 4)
        fzform.data = tutodata.data
        fzform.addEventListener('update', () => {
            data.innerHTML = `<pre>${JSON.stringify(fzform.data, undefined, 4).replace(/\n/g, '<br>')}</pre>`
        })
    }

    setPanel("form")
    const map = L.map('map').setView([48.52, 2.2], 6)
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map)
    const capitalsLayer = L.geoJSON(capitals, { pointToLayer: (feature, latlng) => L.marker(latlng).bindPopup(feature.properties.city) })
        .addTo(map)
        .on('click', function (e) {
            if (dataset == 'CAPITALS') {
                const feature = e.sourceTarget.feature
                const value = `${feature.properties[property]}@${dataset}`
                selectcb(value)
            }
        })
    const countriesLayer = L.geoJSON(countries, { /* style: (feature) => style,*/ onEachFeature :  (feature,layer) => { 
        layer.on({
			click: e => {
                if (dataset == 'COUNTRIES') {
                    const feature = e.sourceTarget.feature
                    const value = `${feature.properties[property]}@${dataset}`
                    selectcb(value)
                }
        }})
    }})
        .addTo(map)
    window.addEventListener('load', goto)
</script>

</html>