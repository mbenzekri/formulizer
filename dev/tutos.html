<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="../dist/formulizer.js"></script>
    <!-- <script type="module" src="..."></script> importer le module ref-carto ici -->
</head>

<body>
    <style>
        #formPanel {
            width: calc(100% - 20px);
            height: calc(100% - 100px);
        }
        textarea {
            margin: 10px;
            padding: 10px;
            border: 0;
            width: calc(100% - 32px);
            height: 150px;
            font-size: 10pt;
            font-family: monospace;
            line-height: 20pt;
        }

        #form {
            width: 100%;
        }
        #schema {
            width:100%;
            height: calc(100vh - 100px);
        }
        #data {
            width:100%;
            height: calc(100vh - 100px);
        }
    </style>
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" onclick="setPanel('form')">Formulaire</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" onclick="setPanel('schema')">Form</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" onclick="setPanel('data')">Data</a>
        </li>
    </ul>

    <div id=formPanel> <fz-form id=form ></fz-form> </div>
    <div id=schemaPanel> <textarea readonly id=schema ></textarea></div>
    <div id=dataPanel>  <textarea readonly id=data > </textarea> </div>

</body>

<script>
    const panels = {
        form: document.getElementById('formPanel'),
        schema: document.getElementById('schemaPanel'),
        data: document.getElementById('dataPanel')
    }

    const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50">
        <circle cx="25" cy="25" r="20"/>
        </svg>`;
    const form = document.getElementById('form')
    const schema = document.getElementById('schema')
    const data = document.getElementById('data')
    const timer = null
    const ignoreC = (key,value) => ["parent","root"].includes(key) ? undefined : value

    function setPanel(panel) {
        Object.keys(panels).forEach(id => panels[id].style.display = "none");
        if (panel =="data") data.value = JSON.stringify(form.data, undefined, 4)
        if (panel =="schema") schema.value = JSON.stringify(form.schema, ignoreC, 4)
        panels[panel].style.display = "block"
    }


    async function init_options(form) {

        // app enums references
        const enums = {
            PRIMES : [{ value: 2, title: "2" }, { value: 3, title: "Trois" }, { value: 5, title: "Cinq" }]
        } 

        // app data read/write API
        let first_name = "Guillaume"
        let last_name = "Tell"
        let job = "Archer"

        // app document storage API
        const documents = new Map
        const minion = await fetch(`./minion.png`).then(r => r.blob())
        const bad = await fetch(`./bad.png`).then(r => r.blob())
        const agnes = await fetch(`./agnes.png`).then(r => r.blob())
        // add prexisting documents
        documents.set("59cbefd0-6300-11ec-b87d-af00ce201501", { filename: "minion.png", blob: minion, pointer: "/document" })
        documents.set("8724dd60-6301-11ec-9cc0-3783f1582eaa", { filename: "bad.png", blob: bad, pointer: "/documents/0" })
        documents.set("59cbefd0-6300-11ec-b87d-af00ce201999", { filename: "agnes.png", blob: agnes, pointer: "/documents/1" })

        form.options = {
            ref: (enumName) => {
                return enums[enumName] ?? []
            },
            userdata: {
                profil: {
                    get first_name() { return first_name },
                    set first_name(value) {
                        first_name = value
                        console.log(`first_name updated : ${first_name}`)
                    },
                    get last_name() { return last_name },
                    set last_name(value) {
                        last_name = value
                        console.log(`last_name updated : ${last_name}`)
                    },
                    get job() { return job },
                    set job(value) {
                        job = value
                        console.log(`job updated : ${job}`)
                    }
                }
            },
            storage: {
                put: (uuid, blob, filename, pointer) => { documents.set(uuid, { blob, filename, pointer }) },
                remove: (uuid) => { documents.delete(uuid) },
                get: (uuid) => { return documents.get(uuid) }
            }
        }

    }
    const goto = async () => {
        const subject = location.hash.substring(1) ?? "basic"
        if (subject) {
            const tutodata = await fetch(`./tutos/${subject}.json`).then(r => r.json())
            await init_options(form)
            form.schema = tutodata.form
            form.value = JSON.stringify(tutodata.form, null, 4)
            form.data = tutodata.data
            if (timer) clearInterval(timer)
            form.addEventListener('update', () => {
                data.value = JSON.stringify(form.data, undefined, 4)
            })
        }
    }

    setPanel("form")
    window.addEventListener('hashchange', goto)
    window.addEventListener('load', goto)

</script>

</html>